<!DOCTYPE html>
<html lang="de" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Stellwerk – Gleisbelegung</title>
  <meta name="description" content="Gleisbelegung mit optionaler Auto‑Freimeldung aus TD2‑Log. Mehrsprachig (DE/EN/PL). Inklusive Light/Dark/Auto-Theme." />
  <style>
    /* ========== THEME: CSS-Variablen (Light/Dark/Auto via [data-theme]) ========== */
    /* Light (Default Vars) */
    :root{
      --bg:#f5f7fb; --panel:#ffffff; --panel-2:#f0f4fa; --text:#0b1220; --muted:#4b5770; --accent:#2f6df7;
      --free:#1f8a46; --occupied:#cc2e2e; --border:#d9e1ef; --input-bg:#f8fbff; --focus:#245fff;
      --shadow:0 8px 24px rgba(15,23,42,.08); --radius:16px;
    }
    /* Dark */
    html[data-theme="dark"]{
      --bg:#0b0f14; --panel:#121821; --panel-2:#0e141c; --text:#e6eef8; --muted:#93a1b5; --accent:#2f81f7;
      --free:#1f7a3a; --occupied:#b32d2d; --border:#1f2733; --input-bg:#0c121a; --focus:#5aa7ff;
      --shadow:0 6px 20px rgba(0,0,0,.35);
    }
    /* Auto = folgt dem System. Wir überschreiben die Variablen abhängig vom Systemmodus */
    @media (prefers-color-scheme: dark){
      html[data-theme="auto"]{
        --bg:#0b0f14; --panel:#121821; --panel-2:#0e141c; --text:#e6eef8; --muted:#93a1b5; --accent:#2f81f7;
        --free:#1f7a3a; --occupied:#b32d2d; --border:#1f2733; --input-bg:#0c121a; --focus:#5aa7ff;
        --shadow:0 6px 20px rgba(0,0,0,.35);
      }
    }

    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--panel-2),var(--bg));color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .wrap{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:16px}
    header{display:grid;gap:12px;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .row{display:grid;gap:12px}
    @media (min-width:720px){.row{grid-template-columns:1fr 1fr 1fr;align-items:end}}
    label{font-size:14px;color:var(--muted)}
    .input,select,button{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid var(--border);background:var(--input-bg);color:var(--text);padding:12px 14px;font-size:16px;outline:none}
    .input:focus,select:focus{border-color:var(--focus);box-shadow:0 0 0 3px color-mix(in oklab,var(--focus) 20%,transparent)}
    .btn{background:var(--accent);border:none;color:#fff;font-weight:600;cursor:pointer;transition:transform .04s,filter .2s}
    .btn:active{transform:translateY(1px)}.btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}.btn.warn{background:var(--occupied)}.btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    .toolbar{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}@media (min-width:720px){.toolbar{grid-template-columns:repeat(5,1fr)}}
    .board{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:8px;display:grid;gap:10px}
    .track{display:grid;grid-template-columns:88px 1fr 88px;align-items:center;gap:10px;padding:10px;border-radius:14px;border:1px solid var(--border);background:linear-gradient(180deg,color-mix(in oklab,var(--panel) 92%,black 8%),var(--panel-2))}
    .label{font-weight:700;letter-spacing:.2px;text-align:center}
    .occupancy{height:38px;display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;border:1px dashed var(--border);border-radius:12px;background:linear-gradient(90deg,transparent 0 10px,var(--border) 10px 11px,transparent 11px),linear-gradient(90deg,transparent calc(100% - 11px),var(--border) calc(100% - 11px) calc(100% - 10px),transparent calc(100% - 10px));position:relative;overflow:hidden}
    .occupancy[data-state="free"]{box-shadow:inset 0 0 0 2px color-mix(in oklab,var(--free) 40%,transparent)}.occupancy[data-state="occ"]{box-shadow:inset 0 0 0 2px color-mix(in oklab,var(--occupied) 45%,transparent)}
    .mid-input{width:100%;background:transparent;border:none;color:var(--text);text-align:center;font-size:18px;font-weight:700}.mid-input::placeholder{color:var(--muted);font-weight:500}.mid-input:focus{outline:none}
    .pill{justify-self:center;font-size:12px;font-weight:700;letter-spacing:.3px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:color-mix(in oklab,var(--panel-2) 70%,black 30%)}.pill.free{color:var(--free);border-color:color-mix(in oklab,var(--free) 40%,var(--border))}.pill.occ{color:#fff;background:var(--occupied);border-color:color-mix(in oklab,var(--occupied) 60%,black 40%)}
    .hint{color:var(--muted);font-size:12px}
    .footer{color:var(--muted);font-size:12px;text-align:center;padding:8px 0 20px}
    @media (max-width:480px){.track{grid-template-columns:74px 1fr 74px}.mid-input{font-size:16px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <div>
          <label for="station" data-i18n="stationLabel">Bahnhof (Name/Profil)</label>
          <input id="station" class="input" type="text" placeholder="z. B. Aarburg-Oftringen" />
        </div>
        <div>
          <label for="trackCount" data-i18n="trackCountLabel">Anzahl Gleise</label>
          <input id="trackCount" class="input" type="number" min="1" max="60" step="1" value="8" />
        </div>
        <div>
          <label for="lang" data-i18n="language">Sprache</label>
          <select id="lang" class="input">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
            <option value="pl">Polski</option>
          </select>
        </div>
      </div>

      <div class="toolbar">
        <button id="apply" class="btn" data-i18n="apply">Anwenden/Neu aufbauen</button>
        <button id="save" class="btn secondary" data-i18n="save">Profil speichern</button>
        <button id="load" class="btn secondary" data-i18n="load">Profil laden</button>
        <button id="clearAll" class="btn warn" data-i18n="clearAll">Alle Gleise freigeben</button>
        <!-- Theme switcher block -->
        <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center">
          <label for="themeSelect" data-i18n="themeLabel">Theme</label>
          <select id="themeSelect" class="input">
            <option value="auto" data-i18n="themeAuto">Auto (System)</option>
            <option value="light" data-i18n="themeLight">Hell</option>
            <option value="dark" data-i18n="themeDark">Dunkel</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <div>
          <label for="autoClearToggle" data-i18n="autoClear">Auto‑Freimeldung (Log überwachen)</label>
          <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center">
            <input id="autoClearToggle" type="checkbox" />
            <span class="hint" id="autoHint">Wenn aktiv, werden Gleise automatisch freigemeldet, sobald im Log eine Meldung „is leaving scenery…“ für die eingetragene Zugnummer erscheint.</span>
          </div>
        </div>
        <div>
          <label for="pollInterval" data-i18n="pollInterval">Prüfintervall</label>
          <select id="pollInterval" class="input">
            <option value="2000">2 s</option>
            <option value="3000" selected>3 s</option>
            <option value="5000">5 s</option>
            <option value="10000">10 s</option>
          </select>
        </div>
      </div>

      <div class="toolbar">
        <button id="pickLog" class="btn" data-i18n="pickLog">Log‑Datei wählen</button>
        <button id="stopWatch" class="btn secondary" data-i18n="stopWatch">Überwachung stoppen</button>
        <button id="testLine" class="btn ghost" data-i18n="test">Erkennung testen</button>
        <span id="logStatus" class="hint" style="align-self:center"></span>
      </div>

      <span class="hint" id="tip">Tipp: Zugnummer in die Mitte eines Gleises tippen ⇒ Gleis wird als <strong>belegt</strong> markiert. Löschen ⇒ <strong>frei</strong>.</span>
    </header>

    <main id="board" class="board" aria-live="polite"></main>

    <div class="footer" id="footer">Lokal, offline, ohne Server. Daten werden im Browser gespeichert (localStorage). Optional: Log‑Überwachung via File System Access API (Chromium‑Browser).</div>
  </div>

  <script>
    // --- THEME: persistente Umschaltung Light/Dark/Auto ---
    const THEME_KEY = 'stellwerk:theme';
    const themeSelect = document.getElementById('themeSelect');
    function applyTheme(mode){
      const m = (mode==='light'||mode==='dark') ? mode : 'auto';
      document.documentElement.setAttribute('data-theme', m);
      try{ localStorage.setItem(THEME_KEY, m); }catch(e){}
    }
    // Initial: gespeichertes Theme anwenden
    (function(){
      const saved = (localStorage.getItem(THEME_KEY)||'auto');
      if(themeSelect){ themeSelect.value = saved; }
      applyTheme(saved);
      // Systemwechsel live reflektieren, wenn Auto
      const media = window.matchMedia('(prefers-color-scheme: dark)');
      media.addEventListener?.('change', ()=>{
        if((themeSelect?.value||'auto')==='auto'){ applyTheme('auto'); }
      });
      themeSelect?.addEventListener('change', ()=> applyTheme(themeSelect.value));
    })();

    // --- i18n ---
    const KEY_LANG = 'stellwerk:lang';
    let lang = localStorage.getItem(KEY_LANG) || (navigator.language||'de').slice(0,2);
    if (!['de','en','pl'].includes(lang)) lang = 'de';

    const I18N = {
      de: {
        title:'Stellwerk – Gleisbelegung', stationLabel:'Bahnhof (Name/Profil)', stationPh:'z. B. Aarburg-Oftringen', trackCountLabel:'Anzahl Gleise',
        language:'Sprache', apply:'Anwenden/Neu aufbauen', save:'Profil speichern', load:'Profil laden', clearAll:'Alle Gleise freigeben',
        tip:'Tipp: Zugnummer in die Mitte eines Gleises tippen ⇒ Gleis wird als <strong>belegt</strong> markiert. Löschen ⇒ <strong>frei</strong>.',
        footer:'Lokal, offline, ohne Server. Daten werden im Browser gespeichert (localStorage). Optional: Log‑Überwachung via File System Access API (Chromium‑Browser).',
        trainPlaceholder:'Zugnummer…', trackLabel:'Gleis {n}', occupiedShort:'BELEGT', freeShort:'FREI',
        alertNeedName:'Bitte Stations-/Profilnamen eingeben.', alertSaved:'Profil gespeichert.', alertNoProfiles:'Keine gespeicherten Profile gefunden.',
        promptLoad:'Profilname laden (verfügbar):\n', alertNotFound:'Profil nicht gefunden.', confirmClearAll:'Alle Zugnummern löschen und alle Gleise freigeben?',
        autoClear:'Auto‑Freimeldung (Log überwachen)', pollInterval:'Prüfintervall', pickLog:'Log‑Datei wählen', stopWatch:'Überwachung stoppen', test:'Erkennung testen',
        autoHint:'Wenn aktiv, werden Gleise automatisch freigemeldet, sobald im Log eine Meldung „is leaving scenery…“ für die eingetragene Zugnummer erscheint.',
        themeLabel:'Theme', themeAuto:'Auto (System)', themeLight:'Hell', themeDark:'Dunkel'
      },
      en: {
        title:'Signal Box – Track Occupancy', stationLabel:'Station (Name/Profile)', stationPh:'e.g. Aarburg-Oftringen', trackCountLabel:'Number of tracks',
        language:'Language', apply:'Apply/Rebuild', save:'Save profile', load:'Load profile', clearAll:'Clear all tracks',
        tip:'Tip: Type the train number in the middle of a track ⇒ track is marked <strong>occupied</strong>. Delete ⇒ <strong>free</strong>.',
        footer:'Local, offline, no server. Data is stored in the browser (localStorage). Optional: log monitoring via File System Access API (Chromium).',
        trainPlaceholder:'Train number…', trackLabel:'Track {n}', occupiedShort:'OCCUPIED', freeShort:'FREE',
        alertNeedName:'Please enter a station/profile name.', alertSaved:'Profile saved.', alertNoProfiles:'No saved profiles found.',
        promptLoad:'Load profile (available):\n', alertNotFound:'Profile not found.', confirmClearAll:'Clear all train numbers and free all tracks?',
        autoClear:'Auto‑clear (monitor log)', pollInterval:'Polling interval', pickLog:'Choose log file', stopWatch:'Stop monitoring', test:'Test detection',
        autoHint:'When enabled, tracks are auto‑cleared once a log line “is leaving scenery…” appears for the entered train number.',
        themeLabel:'Theme', themeAuto:'Auto (System)', themeLight:'Light', themeDark:'Dark'
      },
      pl: {
        title:'Nastawnia – Zajętość torów', stationLabel:'Stacja (nazwa/profil)', stationPh:'np. Aarburg-Oftringen', trackCountLabel:'Liczba torów',
        language:'Język', apply:'Zastosuj/Przebuduj', save:'Zapisz profil', load:'Wczytaj profil', clearAll:'Zwolnij wszystkie tory',
        tip:'Wskazówka: wpisz numer pociągu na środku toru ⇒ tor oznaczony jako <strong>zajęty</strong>. Usuń numer ⇒ <strong>wolny</strong>.',
        footer:'Lokalnie, offline, bez serwera. Dane są przechowywane w przeglądarce (localStorage). Opcjonalnie: monitorowanie logu przez File System Access API (Chromium).',
        trainPlaceholder:'Numer pociągu…', trackLabel:'Tor {n}', occupiedShort:'ZAJĘTY', freeShort:'WOLNY',
        alertNeedName:'Podaj nazwę stacji/profilu.', alertSaved:'Profil zapisany.', alertNoProfiles:'Brak zapisanych profili.',
        promptLoad:'Wczytaj profil (dostępne):\n', alertNotFound:'Nie znaleziono profilu.', confirmClearAll:'Usunąć wszystkie numery pociągów i zwolnić wszystkie tory?',
        autoClear:'Auto‑zwalnianie (monitoruj log)', pollInterval:'Częstotliwość sprawdzania', pickLog:'Wybierz plik logu', stopWatch:'Zatrzymaj monitorowanie', test:'Test wykrywania',
        autoHint:'Po włączeniu tor jest zwalniany, gdy w logu pojawi się linia „is leaving scenery…” dla wpisanego numeru pociągu.',
        themeLabel:'Motyw', themeAuto:'Auto (system)', themeLight:'Jasny', themeDark:'Ciemny'
      }
    };
    const t = (k)=> (I18N[lang]&&I18N[lang][k])||I18N.de[k]||k;
    const getTrackLabel = (n)=> t('trackLabel').replace('{n}', n);

    function applyI18nStatic(){
      document.title = t('title');
      const map = [
        ['label[for="station"]','textContent','stationLabel'],
        ['#station','placeholder','stationPh'],
        ['label[for="trackCount"]','textContent','trackCountLabel'],
        ['label[for="lang"]','textContent','language'],
        ['#apply','textContent','apply'],
        ['#save','textContent','save'],
        ['#load','textContent','load'],
        ['#clearAll','textContent','clearAll'],
        ['#tip','innerHTML','tip'],
        ['#footer','textContent','footer'],
        ['label[for="autoClearToggle"]','textContent','autoClear'],
        ['label[for="pollInterval"]','textContent','pollInterval'],
        ['#pickLog','textContent','pickLog'],
        ['#stopWatch','textContent','stopWatch'],
        ['#testLine','textContent','test'],
        ['#autoHint','textContent','autoHint'],
        ['label[for="themeSelect"]','textContent','themeLabel'],
      ];
      map.forEach(([sel,prop,key])=>{ const el=document.querySelector(sel); if(el) el[prop]=t(key); });
      // Options im Theme-Select lokalisieren
      const themeSel = document.getElementById('themeSelect');
      if(themeSel){
        const optMap = [
          ['auto','themeAuto'],
          ['light','themeLight'],
          ['dark','themeDark'],
        ];
        [...themeSel.options].forEach(opt=>{
          const pair = optMap.find(p=>p[0]===opt.value);
          if(pair) opt.textContent = t(pair[1]);
        });
      }
      const sIn = document.getElementById('station'); if (sIn) sIn.placeholder = t('stationPh');
    }

    function applyI18nBoard(){
      document.querySelectorAll('.track').forEach((row, idx)=>{
        const left=row.children[0], right=row.children[2];
        const id=Number(row.dataset.track)||(idx+1);
        if(left) left.textContent=getTrackLabel(id);
        if(right) right.textContent=getTrackLabel(id);
        const input=row.querySelector('.mid-input'); if(input) input.placeholder=t('trainPlaceholder');
        const pill=row.querySelector('.pill'); if(pill){
          const occ=row.querySelector('.occupancy')?.dataset.state==='occ';
          pill.textContent = occ ? t('occupiedShort') : t('freeShort');
        }
      });
    }

    function setLang(newLang){ if(!['de','en','pl'].includes(newLang)) return; lang=newLang; localStorage.setItem(KEY_LANG,lang); applyI18nStatic(); applyI18nBoard(); }
    document.getElementById('lang').addEventListener('change', e=> setLang(e.target.value));

    // --- State & Persistence ---
    const $ = (sel, root=document)=> root.querySelector(sel);
    const board = $('#board');
    const stationInput = $('#station');
    const trackCountInput = $('#trackCount');
    const langSelect = $('#lang'); if (langSelect) langSelect.value = lang;
    if (themeSelect) themeSelect.value = (localStorage.getItem(THEME_KEY)||'auto');

    const KEY_LAST = 'stellwerk:lastProfileName';
    const keyFor = (name)=> `stellwerk:profile:${name}`;
    const loadProfile = (name)=>{ if(!name) return null; try{ const raw=localStorage.getItem(keyFor(name)); return raw?JSON.parse(raw):null; }catch{return null;} };
    const saveProfile = (name,data)=>{ if(!name) return; localStorage.setItem(keyFor(name), JSON.stringify(data)); localStorage.setItem(KEY_LAST,name); };
    const getAllProfileNames = ()=> Object.keys(localStorage).filter(k=>k.startsWith('stellwerk:profile:')).map(k=>k.replace('stellwerk:profile:','')).sort((a,b)=>a.localeCompare(b, lang));

    // --- UI Build ---
    function buildBoard(trackCount=8, payload=null){
      board.innerHTML='';
      const data = payload || Array.from({length:trackCount},(_,i)=>({id:i+1,num:''}));
      data.slice(0,trackCount).forEach(({id,num},idx)=>{
        const row=document.createElement('section'); row.className='track'; row.dataset.track=id||idx+1;
        const left=document.createElement('div'); left.className='label'; left.textContent=getTrackLabel(id||idx+1);
        const mid=document.createElement('div'); mid.className='occupancy';
        const pill=document.createElement('span'); pill.className='pill';
        const input=document.createElement('input'); input.className='mid-input'; input.placeholder=t('trainPlaceholder'); input.inputMode='numeric'; input.autocomplete='off'; input.spellcheck=false; input.value=num||'';
        const right=document.createElement('div'); right.className='label'; right.textContent=getTrackLabel(id||idx+1);
        mid.appendChild(document.createElement('div')); mid.appendChild(input); mid.appendChild(document.createElement('div'));
        row.appendChild(left); row.appendChild(mid); row.appendChild(right); board.appendChild(row);
        const applyState=()=>{ const occupied=input.value.trim().length>0; mid.dataset.state=occupied?'occ':'free'; pill.textContent=occupied?t('occupiedShort'):t('freeShort'); pill.className='pill '+(occupied?'occ':'free'); if(!row.contains(pill)) row.appendChild(pill); };
        input.addEventListener('input', ()=>{ applyState(); scheduleAutosave(); });
        applyState();
      });
    }

    // --- Autosave ---
    let autosaveTimer=null; const scheduleAutosave=()=>{ clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveCurrent,250); };
    function readCurrentData(){
      const tracks=[...board.querySelectorAll('.track')].map((row,i)=>{ const input=row.querySelector('.mid-input'); const id=Number(row.dataset.track)||(i+1); return {id, num:(input.value||'').trim()}; });
      return { station:(stationInput.value||'').trim()||'Unbenannt', count:Number(trackCountInput.value)||tracks.length||8, tracks };
    }
    const saveCurrent=()=>{ const data=readCurrentData(); saveProfile(data.station,data); };

    // --- Controls ---
    document.getElementById('apply').addEventListener('click', ()=>{ const count=Math.min(Math.max(Number(trackCountInput.value)||8,1),60); const current=readCurrentData(); let tracks=current.tracks.slice(0,count); if(tracks.length<count){ const s=tracks.length; for(let i=s;i<count;i++) tracks.push({id:i+1,num:''}); } buildBoard(count,tracks); scheduleAutosave(); applyI18nBoard(); });
    document.getElementById('save').addEventListener('click', ()=>{ const name=(stationInput.value||'').trim(); if(!name){ alert(t('alertNeedName')); return;} saveCurrent(); alert(t('alertSaved')); });
    document.getElementById('load').addEventListener('click', ()=>{ const names=getAllProfileNames(); if(!names.length){ alert(t('alertNoProfiles')); return;} const pick=prompt(t('promptLoad')+names.join('\n')); if(!pick) return; const data=loadProfile(pick.trim()); if(!data){ alert(t('alertNotFound')); return;} stationInput.value=data.station||pick; trackCountInput.value=data.count||(data.tracks?.length||8); buildBoard(Number(trackCountInput.value), data.tracks); localStorage.setItem(KEY_LAST, stationInput.value.trim()); applyI18nBoard(); });
    document.getElementById('clearAll').addEventListener('click', ()=>{ if(!confirm(t('confirmClearAll'))) return; [...board.querySelectorAll('.mid-input')].forEach(i=>{ i.value=''; i.dispatchEvent(new Event('input')); }); scheduleAutosave(); });

    // --- Boot ---
    (function init(){ const last=localStorage.getItem(KEY_LAST); if(last){ const data=loadProfile(last); if(data){ stationInput.value=data.station||last; trackCountInput.value=data.count||(data.tracks?.length||8); buildBoard(Number(trackCountInput.value), data.tracks); applyI18nStatic(); applyI18nBoard(); return; } } stationInput.value=''; buildBoard(Number(trackCountInput.value)||8); applyI18nStatic(); applyI18nBoard(); })();

    // --- Log Watch (Auto‑Freimeldung) ---
    const logStatus=document.getElementById('logStatus');
    const autoClearToggle=document.getElementById('autoClearToggle');
    const pollIntervalSel=document.getElementById('pollInterval');
    const pickLogBtn=document.getElementById('pickLog');
    const stopWatchBtn=document.getElementById('stopWatch');
    const testBtn=document.getElementById('testLine');

    // Beispielzeile: [10/13/2025 18:30:27][Log] ChatMessage: (18:30:26) 54100@IC_SU46_1234 is leaving scenery...
    const LINE_RE=/ChatMessage:\s*\(\d{2}:\d{2}:\d{2}\)\s*(\d+)\s*@[^\n]*?is leaving scenery/i;

    let fileHandle=null; let readTimer=null; let lastByteRead=0;
    const setLogStatus=(txt)=>{ if(logStatus) logStatus.textContent=txt||''; };
    function freeTrackByTrainNo(trainNo){ const inputs=[...document.querySelectorAll('.mid-input')]; let freed=false; for(const i of inputs){ if(i.value.trim()===String(trainNo)){ i.value=''; i.dispatchEvent(new Event('input')); freed=true; } } return freed; }
    async function chooseLogFile(){ if(!window.showOpenFilePicker){ alert('Für Live‑Überwachung bitte Chrome/Edge verwenden (File System Access API).'); return false;} try{ const [handle]=await showOpenFilePicker({multiple:false,types:[{description:'TrainDriver2 Logs',accept:{'text/plain':['.log','.txt']}}]}); fileHandle=handle; await primeFilePointer(); setLogStatus('Log gewählt: '+(handle.name||'unbekannt')); return true; }catch{ setLogStatus('Keine Datei gewählt.'); return false; } }
    async function primeFilePointer(){ if(!fileHandle) return; const file=await fileHandle.getFile(); lastByteRead=file.size; }
    async function pollFileOnce(){ if(!fileHandle) return; const file=await fileHandle.getFile(); if(file.size<lastByteRead) lastByteRead=0; if(file.size===lastByteRead) return; const slice=file.slice(lastByteRead,file.size); const text=await slice.text(); lastByteRead=file.size; let hits=0; for(const line of text.split(/\r?\n/)){ const m=LINE_RE.exec(line); if(m){ const trainNo=m[1]; if(freeTrackByTrainNo(trainNo)) hits++; } } if(hits>0) setLogStatus(`Freigemeldet: ${hits} Zug(e) via Log`); }
    function startWatching(){ const interval=Number(pollIntervalSel?.value)||3000; if(!fileHandle){ setLogStatus('Bitte zuerst Log‑Datei wählen.'); return;} if(readTimer) clearInterval(readTimer); readTimer=setInterval(pollFileOnce, interval); setLogStatus('Überwachung aktiv (alle '+Math.round(interval/1000)+'s)'); }
    function stopWatching(){ if(readTimer) clearInterval(readTimer); readTimer=null; setLogStatus('Überwachung gestoppt'); }
    pickLogBtn?.addEventListener('click', async()=>{ const ok=await chooseLogFile(); if(ok && autoClearToggle?.checked) startWatching(); });
    stopWatchBtn?.addEventListener('click', stopWatching);
    autoClearToggle?.addEventListener('change', ()=>{ if(autoClearToggle.checked) startWatching(); else stopWatching(); });
    pollIntervalSel?.addEventListener('change', ()=>{ if(autoClearToggle?.checked && fileHandle) startWatching(); });
    testBtn?.addEventListener('click', ()=>{ const nums=[...document.querySelectorAll('.mid-input')].map(i=>i.value.trim()).filter(Boolean); if(!nums.length){ alert('Keine Zugnummern eingetragen.'); return;} nums.forEach(n=>freeTrackByTrainNo(n)); setLogStatus('Test: alle eingetragenen Züge freigemeldet.'); });
  </script>
</body>
</html>
